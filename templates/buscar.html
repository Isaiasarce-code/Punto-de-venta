<!doctype html>
<html>
<head>
    <title>Buscar producto</title>
</head>
<body>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
        {% for message in messages %}
          <li><strong>{{ message }}</strong></li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <h2>Buscar producto</h2>
    <form method="post">
        <label>Código de barras:</label>
        <input type="text" name="codigo">
        <br>
        <label>Descripción del producto:</label>
        <input type="text" name="descripcion">
        <br>
        <button type="submit">Buscar</button>
    </form>

    {% if error %}
        <p style="color:red">{{ error }}</p>
    {% endif %}

    {% if productos is not none and not productos.empty %}
    <h3>Resultados:</h3>
    <table border="1">
        <tr>
            <th>Código</th>
            <th>Descripción</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Acción</th>
        </tr>
        {% for _, prod in productos.iterrows() %}
        <tr>
            <form method="post">
                <td>{{ prod['codigo'] }}</td>
                <td>{{ prod['descripcion'] }}</td>
                <td>{{ prod['precio'] }}</td>
                <td>
                    <input type="number" name="cantidad" min="1" value="1" required>
                    <input type="hidden" name="codigo" value="{{ prod['codigo'] }}">
                    <input type="hidden" name="descripcion" value="{{ prod['descripcion'] }}">
                    <input type="hidden" name="precio" value="{{ prod['precio'] }}">
                </td>
                <td>
                    <button type="submit" name="agregar" value="1">Agregar al carrito</button>
                </td>
            </form>
        </tr>
        {% endfor %}
    </table>
    {% endif %}
{% if carrito %}
<h3>🛒 Carrito actual:</h3>
<table border="1">
    <tr>
        <th>Descripción</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Subtotal</th>
    </tr>
    {% set total = 0 %}
    
    {% for item in carrito %}
        {% set subtotal = item.precio|float * item.cantidad|float %}
        {% set total = total + subtotal %}
        <tr>
            <td>{{ item.descripcion }}</td>
            <td>{{ item.precio }}</td>
            <td>{{ item.cantidad }}</td>
            <td>{{ "%.2f"|format(subtotal) }}</td>
        </tr>
        
    {% endfor %}
    <tr>
        <td colspan="3"><strong>Total</strong></td>
        <td><strong>{{ "%.2f"|format(total) }}</strong></td>
    </tr>
</table>
<form action="/vender" method="post">
    <button type="submit">Registrar venta</button>
</form>
    <form action="/vaciar_carrito" method="post" style="margin-top: 10px;">
    <button type="submit" style="background-color: crimson; color: white;">Vaciar carrito</button>
</form>

{% endif %}



    
</body>
</html>
